<!-- Views/MessagesTabControl.xaml - Updated version with advanced message filtering -->
<UserControl x:Class="RC_GUI_WATS.Views.MessagesTabControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:views="clr-namespace:RC_GUI_WATS.Views"
             mc:Ignorable="d">
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        
        <!-- Style for message type filter ComboBox -->
        <Style x:Key="MessageTypeFilterComboBoxStyle" TargetType="ComboBox">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ComboBox">
                        <Grid>
                            <ToggleButton Name="ToggleButton" 
                                        Background="White" 
                                        BorderBrush="Gray" 
                                        BorderThickness="1"
                                        IsChecked="{Binding Path=IsDropDownOpen, Mode=TwoWay, RelativeSource={RelativeSource TemplatedParent}}"
                                        ClickMode="Press">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="20"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Grid.Column="0" Text="Message Types" Margin="5,2" VerticalAlignment="Center"/>
                                    <Path Grid.Column="1" HorizontalAlignment="Center" VerticalAlignment="Center" 
                                          Data="M 0 0 L 4 4 L 8 0 Z" Fill="Gray"/>
                                </Grid>
                            </ToggleButton>
                            <Popup Name="Popup" 
                                   Placement="Bottom"
                                   IsOpen="{TemplateBinding IsDropDownOpen}"
                                   AllowsTransparency="True" 
                                   Focusable="False"
                                   PopupAnimation="Slide">
                                <Grid MinWidth="{TemplateBinding ActualWidth}" MaxHeight="300">
                                    <Border Background="White" BorderBrush="Gray" BorderThickness="1">
                                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                                            <StackPanel Margin="5">
                                                <!-- Quick action buttons -->
                                                <Grid Margin="0,0,0,5">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="5"/>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="5"/>
                                                        <ColumnDefinition Width="*"/>
                                                    </Grid.ColumnDefinitions>
                                                    <Button Grid.Column="0" Content="All" Command="{Binding SelectAllMessageTypesCommand}" 
                                                            FontSize="10" Padding="3,1"/>
                                                    <Button Grid.Column="2" Content="None" Command="{Binding DeselectAllMessageTypesCommand}" 
                                                            FontSize="10" Padding="3,1"/>
                                                    <Button Grid.Column="4" Content="Reset" Command="{Binding ResetMessageFiltersCommand}" 
                                                            FontSize="10" Padding="3,1"/>
                                                </Grid>
                                                
                                                <Separator Margin="0,0,0,5"/>
                                                
                                                <!-- Order Messages -->
                                                <TextBlock Text="Order Messages" FontWeight="Bold" FontSize="11" Margin="0,5,0,2"/>
                                                <CheckBox Content="OrderAdd" IsChecked="{Binding ShowOrderAdd}" Margin="10,1"/>
                                                <CheckBox Content="OrderAddResponse" IsChecked="{Binding ShowOrderAddResponse}" Margin="10,1"/>
                                                <CheckBox Content="OrderModify" IsChecked="{Binding ShowOrderModify}" Margin="10,1"/>
                                                <CheckBox Content="OrderModifyResponse" IsChecked="{Binding ShowOrderModifyResponse}" Margin="10,1"/>
                                                <CheckBox Content="OrderCancel" IsChecked="{Binding ShowOrderCancel}" Margin="10,1"/>
                                                <CheckBox Content="OrderCancelResponse" IsChecked="{Binding ShowOrderCancelResponse}" Margin="10,1"/>
                                                
                                                <!-- Trade Messages -->
                                                <TextBlock Text="Trade Messages" FontWeight="Bold" FontSize="11" Margin="0,5,0,2"/>
                                                <CheckBox Content="Trade" IsChecked="{Binding ShowTrade}" Margin="10,1"/>
                                                <CheckBox Content="Trade Capture Reports" IsChecked="{Binding ShowTradeCaptureReports}" Margin="10,1"/>
                                                
                                                <!-- Quote Messages -->
                                                <TextBlock Text="Quote Messages" FontWeight="Bold" FontSize="11" Margin="0,5,0,2"/>
                                                <CheckBox Content="MassQuote" IsChecked="{Binding ShowMassQuote}" Margin="10,1"/>
                                                <CheckBox Content="MassQuoteResponse" IsChecked="{Binding ShowMassQuoteResponse}" Margin="10,1"/>
                                                
                                                <!-- Mass Cancel Messages -->
                                                <TextBlock Text="Mass Cancel Messages" FontWeight="Bold" FontSize="11" Margin="0,5,0,2"/>
                                                <CheckBox Content="OrderMassCancel" IsChecked="{Binding ShowOrderMassCancel}" Margin="10,1"/>
                                                <CheckBox Content="OrderMassCancelResponse" IsChecked="{Binding ShowOrderMassCancelResponse}" Margin="10,1"/>
                                                
                                                <!-- System Messages -->
                                                <TextBlock Text="System Messages" FontWeight="Bold" FontSize="11" Margin="0,5,0,2"/>
                                                <CheckBox Content="Reject" IsChecked="{Binding ShowReject}" Margin="10,1"/>
                                                <CheckBox Content="Login/Logout" IsChecked="{Binding ShowLoginLogout}" Margin="10,1"/>
                                                <CheckBox Content="Heartbeat" IsChecked="{Binding ShowHeartbeat}" Margin="10,1"/>
                                                <CheckBox Content="Others" IsChecked="{Binding ShowOthers}" Margin="10,1"/>
                                            </StackPanel>
                                        </ScrollViewer>
                                    </Border>
                                </Grid>
                            </Popup>
                        </Grid>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </UserControl.Resources>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="200"/>
            <RowDefinition Height="5"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Panel Capital -->
        <Grid Grid.Row="0" Margin="5">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="250"/>
                <ColumnDefinition Width="200"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            
            <!-- Left side - capital information -->
            <Border BorderBrush="DarkGray" BorderThickness="1" Grid.Column="0">
                <Grid Margin="5">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- Capital Header -->
                    <TextBlock Grid.Row="0" Grid.ColumnSpan="2" Text="Capital" FontWeight="Bold" Margin="0,0,0,5"/>
                    
                    <!-- Open Capital -->
                    <TextBlock Grid.Row="1" Grid.Column="0" Text="Open Capital:" Margin="0,0,10,0"/>
                    <TextBlock Grid.Row="1" Grid.Column="1" Text="{Binding OpenCapitalText}" HorizontalAlignment="Right"/>
                    
                    <!-- Accrued Capital -->
                    <TextBlock Grid.Row="2" Grid.Column="0" Text="Accrued Capital:" Margin="0,0,10,0"/>
                    <TextBlock Grid.Row="2" Grid.Column="1" Text="{Binding AccruedCapitalText}" HorizontalAlignment="Right"/>
                    
                    <!-- Total Capital -->
                    <TextBlock Grid.Row="3" Grid.Column="0" Text="Total Capital:" Margin="0,0,10,0" FontWeight="SemiBold"/>
                    <TextBlock Grid.Row="3" Grid.Column="1" Text="{Binding TotalCapitalText}" HorizontalAlignment="Right" FontWeight="SemiBold"/>
                    
                    <!-- Limits Header -->
                    <TextBlock Grid.Row="4" Grid.ColumnSpan="2" Text="Limits" FontWeight="Bold" Margin="0,10,0,5"/>
                    
                    <!-- Messages -->
                    <TextBlock Grid.Row="5" Grid.Column="0" Text="Messages:" Margin="0,0,10,0"/>
                    <StackPanel Grid.Row="5" Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right">
                        <TextBlock Text="{Binding MessagesPercentageText}" Foreground="{Binding MessagesPercentageBrush}"/>
                        <TextBlock Text=" of "/>
                        <TextBlock Text="{Binding CurrentCapital.MessagesLimit, StringFormat=N0}"/>
                    </StackPanel>
                    
                    <!-- Capital -->
                    <TextBlock Grid.Row="6" Grid.Column="0" Text="Capital:" Margin="0,0,10,0"/>
                    <StackPanel Grid.Row="6" Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right">
                        <TextBlock Text="{Binding CurrentCapital.CapitalPercentage, StringFormat={}{0:F1}%}" 
                                  Foreground="{Binding CapitalPercentageBrush}"/>
                        <TextBlock Text=" of "/>
                        <TextBlock Text="{Binding CurrentCapital.CapitalLimit, StringFormat=N0}"/>
                    </StackPanel>
                    
                    <!-- RC Messages Counter -->
                    <TextBlock Grid.Row="7" Grid.Column="0" Text="RC Messages:" Margin="0,5,10,0" FontSize="10" Foreground="Gray"/>
                    <TextBlock Grid.Row="7" Grid.Column="1" Text="{Binding CurrentCapital.CurrentMessages, StringFormat=N0}" 
                               HorizontalAlignment="Right" FontSize="10" Foreground="Gray" FontFamily="Consolas"/>
                </Grid>
            </Border>
            
            <!-- CCG Statistics -->
            <Border BorderBrush="DarkGray" BorderThickness="1" Grid.Column="1" Margin="5,0,0,0">
                <StackPanel Margin="5">
                    <TextBlock Text="CCG Messages" FontWeight="Bold" Margin="0,0,0,5"/>
                    <TextBlock Text="{Binding CcgMessageCountText}" FontSize="11"/>
                    <TextBlock Text="{Binding CcgStatisticsText}" FontSize="11" TextWrapping="Wrap" Margin="0,5,0,0"/>
                    <TextBlock Text="{Binding InstrumentMappingText}" FontSize="10" TextWrapping="Wrap" 
                               Margin="0,5,0,0" Foreground="DarkGray"/>
                    
                    <!-- CCG Actions -->
                    <Button Content="Clear CCG" Command="{Binding ClearCcgMessagesCommand}" 
                            Margin="0,10,0,0" Padding="5,2" FontSize="10"/>
                </StackPanel>
            </Border>
            
            <!-- Heartbeat indicator in the top right -->
            <StackPanel Grid.Column="3" VerticalAlignment="Top" Margin="10,0,0,0">
                <TextBlock Text="RC Server Status:" FontSize="11" Margin="0,0,0,2" Foreground="Gray"/>
                <views:HeartbeatIndicatorControl DataContext="{Binding HeartbeatIndicator}"/>
            </StackPanel>
        </Grid>
        
        <!-- Positions DataGrid -->
        <DataGrid Grid.Row="1" AutoGenerateColumns="False" 
                  ItemsSource="{Binding Positions}"
                  CanUserAddRows="False" CanUserDeleteRows="False" IsReadOnly="True" 
                  Margin="5" LoadingRow="PositionsDataGrid_LoadingRow">
            <DataGrid.Columns>
                <DataGridTextColumn Header="#" Width="30">
                    <DataGridTextColumn.Binding>
                        <Binding RelativeSource="{RelativeSource FindAncestor, AncestorType={x:Type DataGridRow}}" 
                                Path="Header"/>
                    </DataGridTextColumn.Binding>
                    <DataGridTextColumn.ElementStyle>
                        <Style TargetType="TextBlock">
                            <Setter Property="HorizontalAlignment" Value="Right"/>
                            <Setter Property="FontSize" Value="10"/>
                            <Setter Property="Foreground" Value="Gray"/>
                        </Style>
                    </DataGridTextColumn.ElementStyle>
                </DataGridTextColumn>
                <DataGridTextColumn Header="ISIN" Binding="{Binding ISIN}" Width="120"/>
                <DataGridTextColumn Header="Ticker" Binding="{Binding Ticker}" Width="80"/>
                <DataGridTextColumn Header="Name" Binding="{Binding Name}" Width="*"/>
                <DataGridTextColumn Header="Net" Binding="{Binding Net}" Width="60">
                    <DataGridTextColumn.ElementStyle>
                        <Style TargetType="TextBlock">
                            <Setter Property="HorizontalAlignment" Value="Right"/>
                        </Style>
                    </DataGridTextColumn.ElementStyle>
                </DataGridTextColumn>
                <DataGridTextColumn Header="OpenLong" Binding="{Binding OpenLong}" Width="80">
                    <DataGridTextColumn.ElementStyle>
                        <Style TargetType="TextBlock">
                            <Setter Property="HorizontalAlignment" Value="Right"/>
                        </Style>
                    </DataGridTextColumn.ElementStyle>
                </DataGridTextColumn>
                <DataGridTextColumn Header="OpenShort" Binding="{Binding OpenShort}" Width="80">
                    <DataGridTextColumn.ElementStyle>
                        <Style TargetType="TextBlock">
                            <Setter Property="HorizontalAlignment" Value="Right"/>
                        </Style>
                    </DataGridTextColumn.ElementStyle>
                </DataGridTextColumn>
            </DataGrid.Columns>
        </DataGrid>
        
        <!-- Splitter -->
        <GridSplitter Grid.Row="2" Height="5" HorizontalAlignment="Stretch" 
                      Background="LightGray" ResizeDirection="Rows"/>
        
        <!-- CCG Messages and Order Book Section -->
        <Grid Grid.Row="3" Margin="5">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="200"/>
                <RowDefinition Height="5"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>
            
            <!-- CCG Messages Header and Filters -->
            <Grid Grid.Row="0" Margin="0,0,0,5">
                <!-- Header row - Title and controls -->
                <StackPanel Orientation="Horizontal" Margin="0,0,0,5">
                    <TextBlock Text="CCG Messages" FontWeight="Bold" VerticalAlignment="Center" Margin="0,0,15,0"/>
                    
                    <!-- Message Type Filter ComboBox -->
                    <ComboBox Width="120" Height="25" Style="{StaticResource MessageTypeFilterComboBoxStyle}"
                              VerticalAlignment="Center" Margin="0,0,10,0"/>
                    
                    <CheckBox x:Name="ShowRawDataCheckBox" Content="Show Raw" VerticalAlignment="Center" Margin="10,0,0,0"/>
                </StackPanel>
            </Grid>
            
            <!-- CCG Messages DataGrid - Updated to use filtered collection -->
            <DataGrid Grid.Row="1" AutoGenerateColumns="False" 
                      ItemsSource="{Binding CcgMessagesView}"
                      CanUserAddRows="False" CanUserDeleteRows="False" IsReadOnly="True"
                      GridLinesVisibility="All"
                      FontSize="10" RowHeight="20"
                      MouseDoubleClick="CcgDataGrid_MouseDoubleClick"
                      LoadingRow="CcgDataGrid_LoadingRow">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="Header" Binding="{Binding Header}" Width="50">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="ToolTip" Value="{Binding RawDataShort}"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                    <DataGridTextColumn Header="Name" Binding="{Binding Name}" Width="120"/>
                    <DataGridTextColumn Header="Date Received" Binding="{Binding DateReceivedDisplay}" Width="85"/>
                    <DataGridTextColumn Header="Transact Time" Binding="{Binding TransactTimeDisplay}" Width="85"/>
                    <DataGridTextColumn Header="Price" Binding="{Binding PriceDisplay}" Width="70">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="HorizontalAlignment" Value="Right"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                    <DataGridTextColumn Header="Qty" Binding="{Binding QuantityDisplay}" Width="60">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="HorizontalAlignment" Value="Right"/>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                    <DataGridTextColumn Header="Side" Binding="{Binding Side}" Width="80">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="HorizontalAlignment" Value="Center"/>
                                <Style.Triggers>
                                    <Trigger Property="Text" Value="Buy">
                                        <Setter Property="Foreground" Value="{Binding DataContext.ConfigurationService.Color_OrderBook_Side_Buy, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                        <Setter Property="FontWeight" Value="Bold"/>
                                    </Trigger>
                                    <Trigger Property="Text" Value="Sell">
                                        <Setter Property="Foreground" Value="{Binding DataContext.ConfigurationService.Color_OrderBook_Side_Sell, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                        <Setter Property="FontWeight" Value="Bold"/>
                                    </Trigger>
                                    <Trigger Property="Text" Value="Trade">
                                        <Setter Property="Foreground" Value="Blue"/>
                                        <Setter Property="FontWeight" Value="Bold"/>
                                    </Trigger>
                                    <Trigger Property="Text" Value="MassQuote">
                                        <Setter Property="Foreground" Value="Purple"/>
                                        <Setter Property="FontWeight" Value="SemiBold"/>
                                    </Trigger>
                                    <Trigger Property="Text" Value="MassQuoteResp">
                                        <Setter Property="Foreground" Value="DarkMagenta"/>
                                        <Setter Property="FontWeight" Value="SemiBold"/>
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                    <DataGridTextColumn Header="InstrumentId" Binding="{Binding InstrumentIdDisplay}" Width="80"/>
                    <DataGridTextColumn Header="ISIN" Binding="{Binding ISINDisplay}" Width="100"/>
                    <DataGridTextColumn Header="Product" Binding="{Binding ProductCodeDisplay}" Width="70"/>
                    <DataGridTextColumn Header="ClientOrderId" Binding="{Binding ClientOrderId}" Width="120"/>
                    <DataGridTextColumn Header="Raw Data" Binding="{Binding RawDataShort}" Width="200" 
                                       Visibility="{Binding IsChecked, ElementName=ShowRawDataCheckBox, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                </DataGrid.Columns>
                
                <!-- Row styling based on message type -->
                <DataGrid.RowStyle>
                    <Style TargetType="DataGridRow">
                        <!-- Default background for alternating rows -->
                        <Setter Property="Background" Value="White"/>
                        <Setter Property="ToolTip" Value="{Binding RawDataHex}"/>
                        <Style.Triggers>
                            <!-- Mouse over effect -->
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="#F0F0F0"/>
                            </Trigger>
                            
                            <!-- Error messages - highest priority -->
                            <DataTrigger Binding="{Binding Header}" Value="ERROR">
                                <Setter Property="Background" Value="{Binding DataContext.ConfigurationService.Color_Ccg_Error, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                <Setter Property="FontWeight" Value="Bold"/>
                            </DataTrigger>
                            
                            <!-- MassQuote messages - light purple -->
                            <DataTrigger Binding="{Binding Name}" Value="MassQuote">
                                <Setter Property="Background" Value="{Binding DataContext.ConfigurationService.Color_Ccg_MassQuote, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                <Setter Property="FontWeight" Value="SemiBold"/>
                            </DataTrigger>
                            
                            <!-- MassQuoteResponse - light magenta -->
                            <DataTrigger Binding="{Binding Name}" Value="MassQuoteResponse">
                                <Setter Property="Background" Value="{Binding DataContext.ConfigurationService.Color_Ccg_MassQuoteResponse, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                            </DataTrigger>
                            
                            <!-- OrderAdd - bright green -->
                            <DataTrigger Binding="{Binding Name}" Value="OrderAdd">
                                <Setter Property="Background" Value="{Binding DataContext.ConfigurationService.Color_Ccg_OrderAdd, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                            </DataTrigger>
                            
                            <!-- OrderAddResponse - light green -->
                            <DataTrigger Binding="{Binding Name}" Value="OrderAddResponse">
                                <Setter Property="Background" Value="{Binding DataContext.ConfigurationService.Color_Ccg_OrderAddResponse, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                            </DataTrigger>
                            
                            <!-- Trade - light blue -->
                            <DataTrigger Binding="{Binding Name}" Value="Trade">
                                <Setter Property="Background" Value="{Binding DataContext.ConfigurationService.Color_Ccg_Trade, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                <Setter Property="FontWeight" Value="SemiBold"/>
                            </DataTrigger>
                            
                            <!-- Cancel messages - light coral -->
                            <DataTrigger Binding="{Binding Name}" Value="OrderCancel">
                                <Setter Property="Background" Value="{Binding DataContext.ConfigurationService.Color_Ccg_OrderCancel, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                            </DataTrigger>
                            <DataTrigger Binding="{Binding Name}" Value="OrderCancelResponse">
                                <Setter Property="Background" Value="{Binding DataContext.ConfigurationService.Color_Ccg_OrderCancelResponse, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                            </DataTrigger>
                            
                            <!-- Modify messages - light yellow -->
                            <DataTrigger Binding="{Binding Name}" Value="OrderModify">
                                <Setter Property="Background" Value="{Binding DataContext.ConfigurationService.Color_Ccg_OrderModify, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                            </DataTrigger>
                            <DataTrigger Binding="{Binding Name}" Value="OrderModifyResponse">
                                <Setter Property="Background" Value="{Binding DataContext.ConfigurationService.Color_Ccg_OrderModifyResponse, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                            </DataTrigger>
                            
                            <!-- Mass Cancel messages - darker coral -->
                            <DataTrigger Binding="{Binding Name}" Value="OrderMassCancel">
                                <Setter Property="Background" Value="{Binding DataContext.ConfigurationService.Color_Ccg_OrderMassCancel, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                            </DataTrigger>
                            <DataTrigger Binding="{Binding Name}" Value="OrderMassCancelResponse">
                                <Setter Property="Background" Value="{Binding DataContext.ConfigurationService.Color_Ccg_OrderMassCancelResponse, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                            </DataTrigger>
                            
                            <!-- Reject - pink -->
                            <DataTrigger Binding="{Binding Name}" Value="Reject">
                                <Setter Property="Background" Value="{Binding DataContext.ConfigurationService.Color_Ccg_Reject, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                <Setter Property="FontWeight" Value="Bold"/>
                            </DataTrigger>
                            
                            <!-- Login messages - orange (suspicious) -->
                            <DataTrigger Binding="{Binding Name}" Value="Login">
                                <Setter Property="Background" Value="{Binding DataContext.ConfigurationService.Color_Ccg_Login, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                            </DataTrigger>
                            <DataTrigger Binding="{Binding Name}" Value="LoginResponse">
                                <Setter Property="Background" Value="{Binding DataContext.ConfigurationService.Color_Ccg_LoginResponse, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                            </DataTrigger>
                            
                            <!-- Trade Capture Reports - light cyan -->
                            <DataTrigger Binding="{Binding Name}" Value="TradeCaptureReportSingle">
                                <Setter Property="Background" Value="{Binding DataContext.ConfigurationService.Color_Ccg_TradeCaptureReportSingle, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                            </DataTrigger>
                            <DataTrigger Binding="{Binding Name}" Value="TradeCaptureReportDual">
                                <Setter Property="Background" Value="{Binding DataContext.ConfigurationService.Color_Ccg_TradeCaptureReportDual, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </DataGrid.RowStyle>
            </DataGrid>
            
            <!-- Splitter between CCG Messages and Order Book -->
            <GridSplitter Grid.Row="2" Height="5" HorizontalAlignment="Stretch" 
                          Background="LightGray" ResizeDirection="Rows"/>

            <!-- Order Book Section -->
            <Grid Grid.Row="3" Margin="0,5,0,0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                
                <!-- Order Book Header -->
                <Grid Grid.Row="0" Margin="0,0,0,5">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <TextBlock Grid.Column="0" Text="Order Book" FontWeight="Bold" 
                               VerticalAlignment="Center" Margin="0,0,15,0"/>
                    
                    <TextBlock Grid.Column="1" Text="{Binding OrderBookStatisticsText}" 
                               VerticalAlignment="Center" FontSize="11" Foreground="DarkBlue"/>
                    
                    <StackPanel Grid.Column="3" Orientation="Horizontal">
                        <Button Content="Clear" Command="{Binding ClearOrderBookCommand}" 
                                Padding="5,2" FontSize="10"/>
                    </StackPanel>
                </Grid>
                
                <!-- Order Book DataGrid -->
                <DataGrid Grid.Row="1" AutoGenerateColumns="False" 
                          ItemsSource="{Binding OrderBook}"
                          CanUserAddRows="False" CanUserDeleteRows="False" IsReadOnly="True"
                          GridLinesVisibility="All" FontSize="10" RowHeight="20"
                          LoadingRow="OrderBookDataGrid_LoadingRow"
                          MouseDoubleClick="OrderBookDataGrid_MouseDoubleClick">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="#" Width="30">
                            <DataGridTextColumn.Binding>
                                <Binding RelativeSource="{RelativeSource FindAncestor, AncestorType={x:Type DataGridRow}}" 
                                        Path="Header"/>
                            </DataGridTextColumn.Binding>
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="HorizontalAlignment" Value="Right"/>
                                    <Setter Property="FontSize" Value="9"/>
                                    <Setter Property="Foreground" Value="Gray"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        
                        <DataGridTextColumn Header="OrderId" Binding="{Binding OrderId}" Width="80">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="FontFamily" Value="Consolas"/>
                                    <Setter Property="FontSize" Value="9"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        
                        <DataGridTextColumn Header="Created" Binding="{Binding CreatedTime, StringFormat=HH:mm:ss.fff}" Width="75"/>
                        
                        <DataGridTextColumn Header="Side" Binding="{Binding Side}" Width="40">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="HorizontalAlignment" Value="Center"/>
                                    <Setter Property="FontWeight" Value="Bold"/>
                                    <Style.Triggers>
                                        <Trigger Property="Text" Value="Buy">
                                            <Setter Property="Foreground" Value="{Binding DataContext.ConfigurationService.Color_OrderBook_Side_Buy, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                        </Trigger>
                                        <Trigger Property="Text" Value="Sell">
                                            <Setter Property="Foreground" Value="{Binding DataContext.ConfigurationService.Color_OrderBook_Side_Sell, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        
                        <DataGridTextColumn Header="InstrId" Binding="{Binding InstrumentId}" Width="60"/>
                        
                        <DataGridTextColumn Header="ISIN" Binding="{Binding ISIN}" Width="100">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="FontFamily" Value="Consolas"/>
                                    <Setter Property="FontSize" Value="9"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        
                        <DataGridTextColumn Header="Product" Binding="{Binding ProductCode}" Width="70">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="FontFamily" Value="Consolas"/>
                                    <Setter Property="FontSize" Value="9"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        
                        <DataGridTextColumn Header="Type" Binding="{Binding OrderType}" Width="60"/>
                        <DataGridTextColumn Header="TIF" Binding="{Binding TimeInForce}" Width="40"/>
                        
                        <DataGridTextColumn Header="Price" Binding="{Binding PriceDisplay}" Width="70">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="HorizontalAlignment" Value="Right"/>
                                    <Setter Property="FontFamily" Value="Consolas"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        
                        <DataGridTextColumn Header="Orig Qty" Binding="{Binding OriginalQuantity}" Width="60">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="HorizontalAlignment" Value="Right"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        
                        <DataGridTextColumn Header="Curr Qty" Binding="{Binding CurrentQuantity}" Width="60">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="HorizontalAlignment" Value="Right"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        
                        <DataGridTextColumn Header="Filled" Binding="{Binding FilledQuantity}" Width="60">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="HorizontalAlignment" Value="Right"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        
                        <DataGridTextColumn Header="Status" Binding="{Binding Status}" Width="80">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="HorizontalAlignment" Value="Center"/>
                                    <Style.Triggers>
                                        <Trigger Property="Text" Value="New">
                                            <Setter Property="Foreground" Value="Blue"/>
                                        </Trigger>
                                        <Trigger Property="Text" Value="PartiallyFilled">
                                            <Setter Property="Foreground" Value="Orange"/>
                                        </Trigger>
                                        <Trigger Property="Text" Value="Filled">
                                            <Setter Property="Foreground" Value="Green"/>
                                            <Setter Property="FontWeight" Value="Bold"/>
                                        </Trigger>
                                        <Trigger Property="Text" Value="Cancelled">
                                            <Setter Property="Foreground" Value="Red"/>
                                        </Trigger>
                                        <Trigger Property="Text" Value="Rejected">
                                            <Setter Property="Foreground" Value="DarkRed"/>
                                            <Setter Property="FontWeight" Value="Bold"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        
                        <DataGridTextColumn Header="Mods" Binding="{Binding ModificationCount}" Width="40">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="HorizontalAlignment" Value="Center"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        
                        <DataGridTextColumn Header="Trades" Binding="{Binding TradeCount}" Width="50">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="HorizontalAlignment" Value="Center"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                        
                        <DataGridTextColumn Header="ClientOrderId" Binding="{Binding ClientOrderId}" Width="120"/>
                        
                        <DataGridTextColumn Header="Last Update" Binding="{Binding LastModifiedTime, StringFormat=HH:mm:ss.fff}" Width="75"/>
                    </DataGrid.Columns>
                    
                    <!-- Row styling -->
                    <DataGrid.RowStyle>
                        <Style TargetType="DataGridRow">
                            <Setter Property="Background" Value="White"/>
                            <Style.Triggers>
                                <!-- Active orders - light blue -->
                                <DataTrigger Binding="{Binding Status}" Value="New">
                                    <Setter Property="Background" Value="{Binding DataContext.ConfigurationService.Color_OrderBook_Status_New, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                </DataTrigger>
                                
                                <!-- Partially filled - light yellow -->
                                <DataTrigger Binding="{Binding Status}" Value="PartiallyFilled">
                                    <Setter Property="Background" Value="{Binding DataContext.ConfigurationService.Color_OrderBook_Status_PartiallyFilled, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                </DataTrigger>
                                
                                <!-- Filled - light green -->
                                <DataTrigger Binding="{Binding Status}" Value="Filled">
                                    <Setter Property="Background" Value="{Binding DataContext.ConfigurationService.Color_OrderBook_Status_Filled, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                </DataTrigger>
                                
                                <!-- Cancelled - light gray -->
                                <DataTrigger Binding="{Binding Status}" Value="Cancelled">
                                    <Setter Property="Background" Value="{Binding DataContext.ConfigurationService.Color_OrderBook_Status_Cancelled, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                    <Setter Property="Foreground" Value="Gray"/>
                                </DataTrigger>
                                
                                <!-- Rejected - light red -->
                                <DataTrigger Binding="{Binding Status}" Value="Rejected">
                                    <Setter Property="Background" Value="{Binding DataContext.ConfigurationService.Color_OrderBook_Status_Rejected, RelativeSource={RelativeSource AncestorType=UserControl}}"/>
                                </DataTrigger>
                                
                                <!-- Mouse over -->
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="#D0D0D0"/>
                                </Trigger>
                            </Style.Triggers>
                        </Style>
                    </DataGrid.RowStyle>
                </DataGrid>
            </Grid>
        </Grid>
        
        <!-- Buttons panel -->
        <StackPanel Grid.Row="4" Orientation="Horizontal" HorizontalAlignment="Left" Margin="5">
            <Button Content="Kill switch" Background="Red" Foreground="White" 
                    Command="{Binding AllSwitchCommand}"
                    Padding="10,2" Margin="0,0,5,0"/>
        </StackPanel>
    </Grid>
</UserControl>